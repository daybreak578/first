<!DOCTYPE html>
<html lang="en">
<link rel="stylesheet" href="교통현황.css">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="text/javascript" src="./jquery-3.7.1.min.js"></script> <!--jquery 주소변경-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>
    <script src="script.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            let regionCodes = []; // 전역 변수로 regionCodes 선언

            // 지역을 선택했을 때, regionCodes 업데이트
            function updateRegion(region) {
                //경상 :906,905,908,915
                //충청 : 907,958,903
                //전라 : 927,928(입구만),904
                //서울 : 918
                //경기:901,919
                //강원:902
                switch (region) {
                    case "서울":
                        regionCodes = ["918","901"];
                        break;
                    case "경기":
                        regionCodes = ["901", "919"];
                        break;
                    case "강원":
                        regionCodes = ["918","902"];
                        break;
                    case "충청":
                        regionCodes = ["907", "958", "903"];
                        break;
                    case "경상":
                        regionCodes = ["906", "905", "908", "915"];
                        break;
                    case "전라":
                        regionCodes = ["927", "928", "904"];
                        break;
                    default:
                        regionCodes = []; // 기본값 (빈 배열)
                }
                console.log("선택된 지역 코드:", regionCodes);  // 추가: 선택된 지역의 코드 확인
            }

            // 교통 데이터를 가져오는 함수
            function fetchTrafficData() {

                const requests = regionCodes.map(function (code) {
                    
                    return $.ajax({
                        url: "https://data.ex.co.kr/openapi/trafficapi/trafficRegion",
                        type: "GET",
                        data: {
                            key: "3762609281",
                            type: "json",
                            numOfRows: 99,
                            pageNo: 1,
                            regionCode: code,
                            inoutType: 0,
                        },
                        dataType: "json",
                    });
                });

                $.when.apply($, requests)
                    .done(function () {
                        const responses = [].slice.call(arguments).map(function (response) {
                            return response[0]; // 각 AJAX 응답의 첫 번째 인자
                        });
                        console.log("응답 데이터:", responses); // 응답 데이터 확인
                        let totalTraffic = [];
                        let traffic = 0;
                        let name = [];
                        for (let j = 0; j < responses.length; j++) {
                            let response = responses[j];
                            for (let k = 0; k < response.trafficRegion.length; k++) {
                                let item = response.trafficRegion[k];
                                traffic += parseInt(item.trafficAmout) || 0;
                            }

                            totalTraffic[j] = traffic;
                            name[j] = response.trafficRegion[0].regionName;
                        }
                        console.log("총 교통량 데이터:", totalTraffic);  // 추가: 교통량 데이터 확인
                        console.log("지역 이름:", name);  // 추가: 지역 이름 확인
                        let backgroundColors = [];
                        let borderColors = [];
                        function getRandomColor() {
                            var r = Math.floor(Math.random() * 256);
                            var g = Math.floor(Math.random() * 256);
                            var b = Math.floor(Math.random() * 256);
                            return "rgba(" + r + ", " + g + ", " + b + ")";
                        }

                        for (var i = 0; i < name.length; i++) {
                            backgroundColors.push(getRandomColor());
                            borderColors.push("black");
                        }

                        // 차트 생성
                        let ctx = document.getElementById("myChart").getContext("2d");
                        let myChart = new Chart(ctx, {
                            type: "bar", // 차트 종류를 bar로 설정
                            data: {
                                labels: name, // x축 레이블
                                datasets: [
                                    {
                                        label: "교통량",
                                        data: totalTraffic, // 각 막대의 데이터 값
                                        backgroundColor: backgroundColors,
                                        borderColor: borderColors,
                                        borderWidth: 1,
                                    },
                                ],
                            },
                            options: {
                                responsive: true, // 반응형 설정
                                aspectRatio: 0.78,
                                scales: {
                                    y: {
                                        beginAtZero: true, // y축을 0부터 시작
                                    },
                                },
                            },
                        });
                    })
                    .fail(function () {
                        console.error("API 요청 중 오류 발생");
                        $("#result").text("API 요청 중 오류 발생");
                    });
            }

            // 지역선택 버튼 클릭 시
            $(".option").on("click", function () {
                let region = $(this).text(); // 클릭한 지역 이름 가져오기
                updateRegion(region); // 지역에 맞는 regionCodes 업데이트
                fetchTrafficData(); // 교통 데이터 요청
            });

            // 지역선택 버튼 클릭 시 드롭다운 메뉴 표시
            $("#select").on("click", function () {
                select();
            });

            function select() {
                for (let i = 0; i < 7; i++) {
                    $(`#option${i}`).css("display", "flex");
                }
            }
        });
    </script>
    <header id="header"></header>
    <!-- 지도불러오기 -->
    <section>
        <div id="select" class="select">지역선택</div>
        <div class="option" id="option1">서울</div>
        <div class="option" id="option2">경기</div>
        <div class="option" id="option3">강원</div>
        <div class="option" id="option4">충청</div>
        <div class="option" id="option5">경상</div>
        <div class="option" id="option6">전라</div>
        <a href="근처휴게소.html" class="restarea">근처휴게소</a>
        <div id="trafficcolor" class="trafficcolor"></div>
        <div id="map" class="map"></div>
        <div class="bar"><canvas id="myChart"></canvas></div>

    </section>
    <!-- 맵불러오기 -->
    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=351c7f5e8166ca2967f8f005df63b4ab"></script>
    <script>
        
        var mapContainer = document.getElementById('map'),
            mapOption = {
                center: new kakao.maps.LatLng(33.450701, 126.570667),
                level: 5
            };
        var map = new kakao.maps.Map(mapContainer, mapOption);

        map.addOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC);
    </script>


</body>

</html>